<link rel="manifest" href="manifest.json" />
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="application-name" content="Summer Todo" />
<meta name="apple-mobile-web-app-title" content="Summer Todo" />
<meta name="msapplication-starturl" content="/index.html" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1, shrink-to-fit=no"
/>
<link rel='stylesheet' href='https://cdn.jsdelivr.net/gh/kognise/water.css@latest/dist/dark.css'>
 <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.0/css/all.css"> 
<style>
	i {
	    cursor: pointer;
	}
	ul {
	list-style: none;
	}
	#menu{
		display: inline;
		margin: 0;
	  padding: 0;	
	}
	#menu li{
		float: left;
	}
	#list{
		margin-top:20px;
	}
	.grid-container {
	  margin-left: 0px;
	  display: grid;
	  grid-template-columns: 20px 20px auto;
	}
</style>
<body onload="onload()">
	<h1><i class="fas fa-list"></i>TodoApp</h1>
	<ul id="menu"><li><a href="#" onclick="showtodo()"> Todo</a></li><li><a href="#" onclick="showproject()">Project</a></li><li>About</li></ul>
	<div id="root"></div>
	<template id="todo">
		<div id="select">
			
		</div>
		<input type="text" placeholder="subject here" id="text"></input>
		<button onclick="todo.add()"><i class="fas fa-plus"></i></button>
		<button onclick="todo.clear1()"><i class="fas fa-trash"></i></button>
		<div id="list">
			<li>li</li>
		</div>	
	</template>
	<template id="project">
		<input type="text" placeholder="project name here" id="text"></input>
		<button onclick="project.add()"><i class="fas fa-plus"></i></button>
		<div id="list">
			<li>li</li>
		</div>	
	</template>
</body>
<script type="text/javascript">
	async function showtodo(){

		const root = document.querySelector("#root");
	  const template = document.querySelector("#todo");
	  const clone = template.content.cloneNode(true);
	  root.innerHTML = ""
	  root.appendChild(clone);
	  var p1 = await dodispatch({resource:"project",action:"list",params:{}})
		var p2 = p1.map(x=>`<option value="${x.id}">${x.name}</option>`)
		document.getElementById("select").innerHTML = 
		`<select id="ps" onchange="todo.onchange()">${p2.join()}</select>`
	  todo.list()
	}
	async function showproject(){
		const root = document.querySelector("#root");
	  const template = document.querySelector("#project");
	  const clone = template.content.cloneNode(true);
	  root.innerHTML = ""
	  root.appendChild(clone);
	  project.list()
	}
	var todo = new class{
		async add(){
			var value = document.getElementById('text').value
			var pid = document.getElementById('ps').value
			var json = {resource:"todo",action:"add",params:{id:Date.now(),subject:value,pid}}
			var data = await dodispatch(json)
	  	this.list()
	  	document.getElementById('text').value = ""
		  	// document.getElementById("container").append("<button>acdkdkdkk</button")
		}
		async docheck (id,checked){
			// var value = document.getElementById('text').value
			// let checked = document.getElementById('checked').value
			var json = {resource:"todo",action:"checked",params:{id,checked}}
			var data = await dodispatch(json)
		  this.list()
		}
		onchange(){
			this.list()
		}
		async remove (id){
			var json = {resource:"todo",action:"remove",params:{id:id}}
			var data = await dodispatch(json)
			this.list()
		}
		async clear1 (){
			// alert(12)
			var json = {resource:"todo",action:"clear",params:{}}
			var data = await dodispatch(json)
			this.list()
		}	
		async list(){
			var pid = document.getElementById('ps').value
			var json = {resource:"todo",action:"list",params:{pid}}
			var data = await dodispatch(json)
			// await dolist("list",data)
			var elementid = "list"
			var options = data
			var m = []
			for (var i = 0; i < options.length; i += 1){
				var checked = options[i].checked?"checked":""
		        m[i] = `
		            <div><i onclick="todo.remove(${options[i].id})" class="fas fa-square-minus"></i></div>
			        <div><input type="checkbox" onclick="todo.docheck(${options[i].id},this.checked)" ${checked}/></div>
			        <div>${options[i].subject}</div>
		        
		        `;
		    }
			document.getElementById(elementid).innerHTML = `<div class="grid-container id="container">`+ m.join("") +`</div>`
		}
	}()
	var project = new class{
		async add(){
			var value = document.getElementById('text').value
			var json = {resource:"project",action:"add",params:{id:Date.now(),name:value}}
			var data = await dodispatch(json)
	  	this.list()
	  	document.getElementById('text').value = ""
		}
		// params {id,name}
		async remove (params){
			var json = {resource:"project",action:"remove",params}
			try{
				var data = await dodispatch(json)	
				this.list()
			}catch(e){
				alert(e.message)
			}
		}
		async list(){
			var json = {resource:"project",action:"list",params:{}}
			var data = await dodispatch(json)
			var elementid = "list"
			var options = data
			var m = []
			for (var i = 0; i < options.length; i += 1){
				var checked = options[i].checked?"checked":""
				var jj = JSON.stringify(options[i])
				jj = jj.replace(/(\r\n|\n|\r)/gm, "")
				jj = jj.replaceAll(`"`,`'`)
				// console.log(jj)
		    m[i] = `
		            <div><i onclick="project.remove(${jj})" class="fas fa-square-minus"></i></div>
			        <div>${options[i].name}</div>
		        	<div></div>
		        `;
		    // console.log(m[i])
		    }
			document.getElementById(elementid).innerHTML = `<div class="grid-container id="container">`+ m.join("") +`</div>`
		}
	}()
	async function dodispatch(json){
		const response = await fetch('/api',{
			headers: {
		      'Accept': 'application/json',
		      'Content-Type': 'application/json'
		    },
		    method: "POST",
		    body: JSON.stringify(json)
		});
	  	const result = await response.json();
	  	// console.log(result)
	  	// return data;
	  	if(result.error)
	  		throw new Error(result.error)
	  		// alert(result.error)
	  		// return result.error
	  	else
	  		return result.data
		// alert(JSON.stringify(data))
	}
	async function onload(){
		await showtodo()
	}
</script>
